{% extends "base.html" %}
{% load custom_tags %}
{% block pre-pf-script %}
<script src="/static/node_modules/datatables.net/js/jquery.dataTables.js"></script>
{% endblock %}
{% block extrascript %}
<script src="/static/js/jquery.flot.js"></script>
<script src="/static/js/jquery.flot.tooltip.js"></script>
<script src="/static/js/csrf.js"></script>
<script src="/static/node_modules/bootstrap-select/js/bootstrap-select.js"></script>
{% endblock %}

{% block pagecontent %}
<div class="panel panel-default">
  <div class="panel-heading">
    {% if packages %}
    <select id="select-package-name" class="selectpicker" data-live-search="true">
      <option selected disabled>Select Package</option>
      {% for package_name, upstream_name in packages %}
      <option>{{ package_name }}</option>
      {% endfor %}
    </select>
    {% else %}
    <br/>
    <p>No package configured. Add
      <a href="{% url 'package-new' %}">one</a> now.</p>
    {% endif %}
    {% if languages %}
    <select id="select-lang-name" class="selectpicker" data-live-search="true">
      <option selected disabled>Select Language</option>
      {% for locale, lang in languages %}
      <option value="{{ locale }}">{{ lang }}</option>
      {% endfor %}
    </select>
    <a id="button-hide-locale-graph" type="button" class="btn btn-default btn-small">
      <span class="fa fa-eye-slash" aria-hidden="true"></span>
    </a>
    {% endif %}
    <span class="text-info pull-right">
      <span class="btn-group" role="group" aria-label="...">
        <button type="button" id="button-tabular" class="btn btn-default">
          <span class="fa fa-th"></span>&nbsp;Tabular</button>
        <button type="button" id="button-graph" class="btn btn-default">
          <span class="fa fa-bar-chart"></span>&nbsp;Graph</button>
      </span>
      <span class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span id="span-refresh-progress">
            <span class="fa fa-refresh" aria-hidden="true"></span>
          </span>
          Sync
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a id="link-sync-transplatform" data-toggle="tooltip" title="Sync with translation platform">
              <input type="hidden" value="syncPlatform" id="sync-package-identifier" />Translation Platform</a>
          </li>
          <li>
            <a href="{% url 'jobs' %}?package={{ package_name }}" data-toggle="tooltip" title="Sync with {{ package_name }} source repo">Upstream Repository</a>
          </li>
          <li>
            <a href="{% url 'jobs-yml-based' %}?package={{ package_name }}" data-toggle="tooltip" title="Sync with build system">Release Build System</a>
          </li>
        </ul>
      </span>
      <span class="btn-group">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          <span id="span-rebuild-progress">
            <span class="fa fa-repeat" aria-hidden="true"></span>
          </span>
          Update
          <span class="caret"></span>
        </button>
        <ul class="dropdown-menu">
          <li>
            <a id="link-create-branch-mapping" data-toggle="tooltip" title="Rebuild Branch Mapping">
              <input type="hidden" value="mapBranches" id="map-branches-identifier" />Branch Mapping</a>
          </li>
          <li>
            <a id="link-create-stats-diff" data-toggle="tooltip" title="Sync done? Rebuild diff">
              <input type="hidden" value="statsDiff" id="stats-diff-identifier" />Statistics Diff</a>
          </li>
        </ul>
      </span>
      <br/>
      <br/>
      <span id="span-alerts" class="text-warning pull-right"></span>
    </span>
  </div>
  <div class="panel-body">
    <div id="div-package-details">
      {% tag_package_details package_name user %}
      <hr>
    </div>
    <div id="div-stats-diff">
      {% tag_stats_diff package_name %}
    </div>
    <div id="div-table-area">
      {% tag_tabular_form package_name %}
    </div>
    <div id="div-graph-group" class="panel panel-default">
      <div class="panel-heading">
          <h3 class="panel-title">Graphs</h3>
          <span id="span-graph-info"></span>
      </div>
      <div id="div-locale-graph" class="graph-area-ts"></div>
      <div id="div-graph-area" class="graph-area-ts"></div>
      <div id="div-graph-disclaimer" class="panel-footer"></div>
    </div>
    <div id="div-branch-mapping">
      {% tag_branch_mapping package_name %}
    </div>
  </div>
</div>

<script>
  function csrfSafeMethod(a) {
    return /^(GET|HEAD|OPTIONS|TRACE)$/.test(a)
  }

  function ajax_tabular() {
    return $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")), waitSpinner.show()
      },
      type: "POST",
      url: "{% url 'ajax-tabular-data' %}",
      data: {
        package: $("#select-package-name").val()
      },
      success: function (a) {
        waitSpinner.hide(), $("#div-table-area").html(a)
      }
    })
  }

  function ajax_graph() {
    var e = $("#select-package-name").val();
    return $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")), $("#div-locale-graph").hide(), $("#button-hide-locale-graph").hide(), $("#select-lang-name").selectpicker("hide"), $("#select-lang-name").selectpicker("val", "Select Language"), waitSpinner.show()
      },
      type: "POST",
      url: "{% url 'ajax-graph-data' %}",
      data: {
        package: e
      },
      dataType: "json",
      success: function (t) {
        waitSpinner.hide();
        var s = t.pkg_desc,
          n = t.graph_data,
          r = t.ticks,
          i = [];
        for (version in n) n.hasOwnProperty(version) && i.push({
          label: version,
          data: n[version]
        });
        var o = {
          series: {
            lines: {
              show: !0,
              lineWidth: .5
            },
            points: {
              radius: 4,
              fill: !0,
              show: !0
            }
          },
          xaxis: {
            axisLabel: "Languages",
            axisLabelUseCanvas: !0,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial",
            axisLabelPadding: 10,
            ticks: r
          },
          yaxis: {
            axisLabel: "Translation",
            axisLabelUseCanvas: !0,
            axisLabelFontSizePixels: 12,
            axisLabelFontFamily: "Verdana, Arial",
            axisLabelPadding: 3,
            tickFormatter: function (a, e) {
              return a + "%"
            },
            minTickSize: 1,
            tickDecimals: 2
          },
          legend: {
            show: !0,
            noColumns: 0,
            labelBoxBorderColor: "Grey",
            position: "ne"
          },
          grid: {
            margin: 10,
            hoverable: !0,
            borderWidth: 2,
            backgroundColor: {
              colors: ["#ffffff", "#EDF5FF"]
            }
          },
          tooltip: {
            show: !0,
            content: "%s | %y translated"
          }
        };
        i.length > 0 && ($("#div-locale-graph").hide(), $("#div-graph-area").show(), $.plot($("#div-graph-area"), i, o), $("#span-graph-info").html("Translation status of " + e + " for " + i.length + " branch(es) in " + r.length + " language(s)"), $("#span-package-desc").html(s), $("#div-graph-disclaimer").html(a), $("#select-lang-name").selectpicker("show"))
      }
    })
  }

  function ajax_locale() {
    var e = $("#select-package-name").val(),
      t = $("#select-lang-name").val();
    return $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")), waitSpinner.show()
      },
      type: "POST",
      url: "{% url 'ajax-graph-data' %}",
      data: {
        package: e,
        locale: t
      },
      dataType: "json",
      success: function (s) {
        waitSpinner.hide();
        var n = s.pkg_desc,
          r = s.graph_data,
          i = s.ticks,
          o = [{
            label: "Translation Progress",
            data: r
          }],
          l = {
            series: {
              bars: {
                show: !0
              }
            },
            bars: {
              align: "center",
              barWidth: .5 * i.length / 10,
              horizontal: !0
            },
            xaxis: {
              axisLabel: "Translation Percentage",
              axisLabelUseCanvas: !0,
              axisLabelFontSizePixels: 12,
              axisLabelFontFamily: "Verdana, Arial",
              axisLabelPadding: 10,
              max: 110,
              tickFormatter: function (a, e) {
                return a + "%"
              }
            },
            yaxis: {
              axisLabel: "Branches",
              axisLabelUseCanvas: !0,
              axisLabelFontSizePixels: 12,
              axisLabelFontFamily: "Verdana, Arial",
              axisLabelPadding: 3,
              ticks: i
            },
            legend: {
              noColumns: 0,
              labelBoxBorderColor: "#000000",
              position: "ne"
            },
            grid: {
              hoverable: !0,
              borderWidth: 2,
              backgroundColor: {
                colors: ["#ffffff", "#EDF5FF"]
              }
            },
            tooltip: {
              show: !0,
              content: "%y | %x translated"
            }
          };
        i.length > 0 && ($("#div-graph-area").hide(), $("#div-locale-graph").show(), $.plot($("#div-locale-graph"), o, l), $("#span-graph-info").html("Translation status of " + t + " for " + i.length + " branch(es) in " + e + " locale"), $("#span-package-desc").html(n), $("#div-graph-disclaimer").html(a), $("#button-hide-locale-graph").show())
      }
    })
  }

  function refresh_package() {
    return $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")), $("#span-refresh-progress").html("<span class='spinner spinner-xs spinner-inline'></span>")
      },
      type: "POST",
      url: "{% url 'ajax-refresh-package' %}",
      data: {
        package: "{{ package_name }}",
        task: $("#sync-package-identifier").val()
      },
      success: function (a) {
        $("#span-refresh-progress").html("<span class='pficon pficon-ok'></span>"), package_details(), load_table(), branch_mapping()
      },
      error: function (a, e, t) {
        $("#span-refresh-progress").html("<span class='pficon pficon-warning-triangle-o'></span>"), $("#span-alerts").html(a.responseText)
      }
    })
  }

  function branch_mapping() {
    $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")), $("#link-create-branch-mapping").attr("disabled", !0), $("#span-rebuild-progress").html("<span class='spinner spinner-xs spinner-inline'></span>")
      },
      type: "POST",
      url: "{% url 'ajax-refresh-package' %}",
      data: {
        package: "{{ package_name }}",
        task: $("#map-branches-identifier").val()
      },
      success: function (a) {
        $("#span-rebuild-progress").html("<span class='pficon pficon-ok' style='color:green'></span>"), $("#link-create-branch-mapping").attr("disabled", !1), setTimeout(function () {
          $("#div-branch-mapping").html(a)
        }, 1e3)
      },
      error: function (a, e, t) {
        $("#span-rebuild-progress").html("<span class='pficon pficon-warning-triangle-o'></span>"), $("#link-create-branch-mapping").attr("disabled", !1), $("#span-alerts").html(a.responseText)
      }
    })
  }

  function stats_diff() {
    $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}")), $("#link-create-stats-diff").attr("disabled", !0), $("#span-rebuild-progress").html("<span class='spinner spinner-xs spinner-inline'></span>")
      },
      type: "POST",
      url: "{% url 'ajax-refresh-package' %}",
      data: {
        package: "{{ package_name }}",
        task: $("#stats-diff-identifier").val()
      },
      success: function (a) {
        $("#span-rebuild-progress").html("<span class='pficon pficon-ok'></span>"), $("#link-create-stats-diff").attr("disabled", !1), setTimeout(function () {
          $("#div-stats-diff").html(a)
        }, 1e3)
      },
      error: function (a, e, t) {
        $("#span-rebuild-progress").html("<span class='pficon pficon-warning-triangle-o'></span>"), $("#link-create-stats-diff").attr("disabled", !1), $("#span-alerts").html(a.responseText)
      }
    })
  }

  function package_details() {
    $.ajax({
      beforeSend: function (a, e) {
        csrfSafeMethod(e.type) || this.crossDomain || (csrftoken ? a.setRequestHeader("X-CSRFToken", csrftoken) : a.setRequestHeader("X-CSRFToken", "{{ csrf_token }}"))
      },
      type: "POST",
      url: "{% url 'ajax-refresh-package' %}",
      data: {
        package: "{{ package_name }}",
        task: "details"
      },
      success: function (a) {
        $("#div-package-details").html(a)
      }
    })
  }

  function load_table() {
    $("#button-graph").removeClass("active"), $("#button-tabular").addClass("active"), ajax_tabular(), $("#button-hide-locale-graph").hide(), $("#select-lang-name").selectpicker("hide"), $("#div-graph-group").hide(), $("#div-table-area").show()
  }
  $(document).ready(function () {
    $("#button-tabular").addClass("active"), $("#div-graph-group").hide(), $("#div-locale-graph").hide(), $("#button-hide-locale-graph").hide(), $("#select-lang-name").selectpicker("hide"), $("#select-package-name").val("{{ package_name }}"), $("#span-alerts").html(""), $("#select-package-name").change(function (a) {
      window.location.replace("/packages/view/" + $(this).val())
    }), $("#button-graph").on('click', function () {
      $("#button-tabular").removeClass("active"), $("#button-graph").addClass("active"), ajax_graph(), $("#div-table-area").hide(), $("#div-graph-group").show()
    }), $("#button-tabular").on('click', function () {
      load_table()
    }), $("#link-sync-transplatform").on('click', function (a) {
      return a.preventDefault(), refresh_package(), !1
    }), $("#link-create-branch-mapping").on('click', function (a) {
      return a.preventDefault(), branch_mapping(), !1
    }), $("#link-create-stats-diff").on('click', function (a) {
      return a.preventDefault(), stats_diff(), !1
    }), $("#select-lang-name").change(function (a) {
      ajax_locale()
    }), $("#button-hide-locale-graph").on('click', function (a) {
      return a.preventDefault(), $("#div-locale-graph").hide(), $("#select-lang-name").selectpicker("val", "Select Language"), $("#span-graph-info").html("&nbsp;"), $("#div-graph-area").show(), $(this).hide()
    })
    $('.selectpicker').selectpicker();
  });
</script>
{% endblock %}
